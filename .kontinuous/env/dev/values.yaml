
app-strapi:
  ~needs: [pg, build-strapi]
  ~preDeploy.cleaner:
    match:
      kind: Deployment
    value: true
  volumes:
    - name: uploads
      emptyDir: {}
  volumeMounts:
    - mountPath: /app/public/uploads
      name: uploads
  envFrom:
    - secretRef:
        name: strapi
    - configMapRef:
        name: strapi-configmap
    - secretRef:
        name: "pg-app"
    # - secretRef:
    #     name: azure-les1000jours-volume

pg:
  ~chart: pg
  # this force ce PG cluster to be destroyed on redeploys
  ~preDeploy.cleaner:
    match:
      kind: Cluster
    value: true
  cnpg-cluster:
    recovery:
      enabled: true
      barmanObjectStore:
        ~tpl~destinationPath: "s3://les1000jours-prod-backups/les1000jours"
        s3Credentials:
          accessKeyId:
            ~tpl~name: "les1000jours-prod-backups-access-key"
            key: bucket_access_key
          secretAccessKey:
            ~tpl~name: "les1000jours-prod-backups-access-key"
            key: bucket_secret_key
          region:
            ~tpl~name: "les1000jours-prod-backups-access-key"
            key: bucket_region
 