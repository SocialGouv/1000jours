global:
  registry: ghcr.io/socialgouv

app-strapi:
  enabled: true
  host: "backoffice-{{ .Values.global.host }}"
  imagePackage: strapi
  containerPort: 1337
  probesPath: /_health
  resources:
    requests:
      cpu: 0.5
      memory: 256Mi
    limits:
      cpu: 1
      memory: 1Gi
  # startupProbe:
  #   initialDelaySeconds: 30
  envFrom:
    - secretRef:
        name: strapi
    - configMapRef:
        name: strapi-configmap
    - secretRef:
        name: "{{ .Values.global.pgSecretName }}"
  env:
    - name: BACKOFFICE_URL
      value: "https://backoffice-{{ .Values.global.host }}"
    - name: DATABASE_CLIENT
      value: "postgres"
    - name: DATABASE_NAME
      value: "$(PGDATABASE)"
    - name: DATABASE_HOST
      value: "$(PGHOST)"
    - name: DATABASE_PORT
      value: "$(PGPORT)"
    - name: DATABASE_USERNAME
      value: "$(PGUSER)"
    - name: DATABASE_PASSWORD
      value: "$(PGPASSWORD)"
    - name: DATABASE_SSL
      value: "true"
#app-cache:
#  image: "nginx:1.19.6"
#  needs: ["app-strapi"]
#  host: "backoffice-{{ .Values.global.host }}"
#  containerPort: 8080
#  volumes:
#    - name: strapi-cache
#      emptyDir: {}
#    - name: "config"
#      configMap:
#        name: nginx-configmap
#  volumeMounts:
#    - name: strapi-cache
#      mountPath: /var/cache/nginx
#    - name: config
#      mountPath: /etc/nginx/nginx.conf
#      subPath: nginx.conf
#  ingress:
#    annotations:
#      "nginx.ingress.kubernetes.io/proxy-body-size": "1g"
#      "nginx.ingress.kubernetes.io/limit-rps": "20"
#      "nginx.ingress.kubernetes.io/limit-rpm": "300"
