include:
  - project: SocialGouv/gitlab-ci-yml
    file: /autodevops.yml
    ref: v23.3.3

variables:
  AUTO_DEVOPS_KANIKO: "‚úîÔ∏è"
  AUTO_DEVOPS_RELEASE_AUTO: "‚úîÔ∏è"
  # AUTO_DEVOPS_PRODUCTION_AUTO: "‚úîÔ∏è"
  AUTO_DEVOPS_ENABLE_KAPP: "‚úîÔ∏è"
  AUTO_DEVOPS_TEST_DISABLED: "üõë"
  AUTO_DEVOPS_QUALITY_DISABLED: "üõë"
  AUTO_DEVOPS_NOTIFY_DISABLED: "üõë"

Lint:
  rules:
    - when: never

Build:
  rules:
    - when: never

Register Kaniko image:
  rules:
    - when: never

K8S Test:
  extends: .autodevops_k8s_test
  rules:
    - if: "$PRODUCTION || $RELEASE"
      when: never
    # NOTE(douglasduteil): ensure to run k8s test
    # - if: "$AUTO_DEVOPS_TEST_DISABLED"
    #  when: never
    - exists:
        - .k8s/package.json

Register strapi:
  extends: .autodevops_register_kaniko_image
  needs: []
  dependencies: []
  variables:
    CONTEXT: back/strapi
    IMAGE_NAME: les1000jours-strapi

# restore develop database on review branches
Restore develop db:
  extends: .autodevops_review
  stage: .post
  allow_failure: True
  variables:
    KOSKO_APPEND_YAML_FROM: ""
    KOSKO_GENERATE_ARGS: "--env dev jobs/restore"
    KAPP_DEPLOY_ARGS: "-a ${CI_PROJECT_NAME}-restore-develop-db"
  environment:
    auto_stop_in: 15 day
    name: ${CI_COMMIT_REF_NAME}${AUTO_DEVOPS_DEV_ENVIRONMENT_NAME}
    on_stop: Stop review
    url: https://${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}
  rules:
    - if: "$CI_COMMIT_BRANCH == 'develop'"
      when: never
    - if: "$CI_COMMIT_TAG"
      when: never
    - when: always

Review:
  extends: .autodevops_review
  # add an exception for the develop branch (permanent env)
  rules:
    - if: "$PRODUCTION || $TRIGGER || $CI_COMMIT_TAG"
      when: never
    - if: "$CI_COMMIT_BRANCH == 'develop'"
      when: never
    - when: on_success

# longer env lifetime for develop branch
Review develop:
  extends: .autodevops_review
  rules:
    - if: "$PRODUCTION || $TRIGGER || $CI_COMMIT_TAG"
      when: never
    - if: "$CI_COMMIT_BRANCH == 'develop'"
      when: on_success
    - when: never
  environment:
    auto_stop_in: 15 day
    name: ${CI_COMMIT_REF_NAME}${AUTO_DEVOPS_DEV_ENVIRONMENT_NAME}
    on_stop: Stop review
    url: https://${CI_ENVIRONMENT_SLUG}-${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}
