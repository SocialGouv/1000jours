name: Build Android App

on:
  push:
    branches: develop-without-expo


jobs:
  mobile-tests:
    name: Mobile Tests
    runs-on: ubuntu-latest
    env:
      MATOMO_APPLICATION_ID: 46
      MATOMO_ENABLED: false
      MATOMO_URL: https://matomo.fabrique.social.gouv.fr/
    steps:

    - uses: actions/checkout@v2

    - name: Run mobile tests
      run: |
          cd front
          yarn install
    #       yarn test

    - name: Write key properties
      shell: bash
      run: |
        cd front/android
        echo "$PROD_KEY_PROPERTIES_B64" | base64 --decode > key.properties
      env:
        PROD_KEY_PROPERTIES_B64: ${{ secrets.PROD_KEY_PROPERTIES_B64 }}

    - name: Write key store
      shell: bash
      run: |
        cd front/android
        ls -la
        mkdir keystore
        echo "$PROD_KEYSTORE_B64" | base64 --decode > keystore/millejours.jks
      env:
        PROD_KEYSTORE_B64: ${{ secrets.PROD_KEYSTORE_B64 }}

    - name: Build the DevDebug App
      run: |
        cd front/android
        ./gradlew bundleDevDebug

    - name: Send APK by mail
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        # Required mail server port:
        server_port: 465
        subject: Android app
        to: yjacqueline@ippon.fr
         # Required sender full name (address can be skipped):
        from: yjacqueline@ippon.fr
        attachments: front/android/app/build/outputs/apk/Dev/debug/app-Dev-debug.apk
